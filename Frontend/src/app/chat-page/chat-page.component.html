<app-left-sidebar></app-left-sidebar>

<app-header></app-header>
<div class="chat-page" *ngIf="currentUserId; else noUser">
  <aside class="chat-sidebar">
    <header class="chat-sidebar__header">
      <div>
        <h2>Mensagens</h2>
        <span>{{ conversations.length }} conversa(s)</span>
      </div>
      <button type="button" class="chat-sidebar__new" (click)="openNewConversationDialog()">
        Nova conversa
      </button>
    </header>

    <section class="chat-sidebar__body" [class.chat-sidebar__body--loading]="loadingConversations">
      <div class="chat-sidebar__hint" *ngIf="loadingConversations">Carregando conversas...</div>
      <div class="chat-sidebar__empty" *ngIf="!loadingConversations && !conversations.length">
        <p>Nenhuma conversa iniciada.</p>
        <p>Use o botão acima para procurar alguém e começar um chat.</p>
      </div>

      <ul class="chat-sidebar__list" *ngIf="conversations.length">
        <li>
          <button
            type="button"
            class="chat-sidebar__search-trigger"
            (click)="openNewConversationDialog()"
          >
            <span>Procurar usuários</span>
          </button>
        </li>

        <li *ngFor="let conversation of conversations" [class.is-active]="conversation.id === activeConversation?.id">
          <button type="button" (click)="selectConversation(conversation)">
            <img
              [src]="avatarSrc(conversation.displayAvatar)"
              [alt]="conversationLabel(conversation)"
              (error)="onAvatarError($event)"
            />
            <div class="chat-sidebar__contact">
              <strong>{{ conversationLabel(conversation) }}</strong>
              <span>{{ conversation.updatedAt | date: 'shortTime' }}</span>
            </div>
          </button>
        </li>
      </ul>
    </section>
  </aside>

  <main class="chat-main" *ngIf="activeConversation; else emptyConversation">
    <header class="chat-main__header">
      <div class="chat-main__recipient" *ngIf="activeRecipient; else anonymousRecipient">
        <img
          [src]="avatarSrc(activeRecipient.displayAvatar)"
          [alt]="activeRecipientName()"
          (error)="onAvatarError($event)"
        />
        <div>
          <h3>{{ activeRecipientName() }}</h3>
          <span>Conversa privada</span>
        </div>
      </div>
      <ng-template #anonymousRecipient>
        <div class="chat-main__recipient">
          <img [src]="defaultAvatar" alt="Contato" (error)="onAvatarError($event)" />
          <div>
            <h3>{{ conversationLabel(activeConversation) }}</h3>
            <span>Conversa privada</span>
          </div>
        </div>
      </ng-template>
      <button type="button" class="chat-main__delete" (click)="deleteActiveConversation()">
        Excluir chat
      </button>
    </header>

    <section class="chat-main__messages" [class.chat-main__messages--loading]="loadingMessages">
      <div class="chat-main__hint" *ngIf="loadingMessages">Carregando mensagens...</div>

      <ng-container *ngIf="!loadingMessages">
        <article
          *ngFor="let message of messages"
          class="chat-message"
          [class.chat-message--me]="message.senderId === currentUserId"
        >
          <div class="chat-message__bubble">
            <div class="chat-message__head">
              <span class="chat-message__author" *ngIf="message.senderId !== currentUserId">
                {{ message.senderName }}
              </span>
              <button
                type="button"
                class="chat-message__delete"
                *ngIf="message.senderId === currentUserId"
                (click)="deleteMessage(message)"
              >
                Excluir
              </button>
            </div>
            <p>{{ message.content }}</p>
            <time>{{ message.createdAt | date: 'shortTime' }}</time>
          </div>
        </article>

        <div class="chat-main__placeholder" *ngIf="!messages.length">
          <p>Envie a primeira mensagem para começar a conversa.</p>
        </div>
      </ng-container>
    </section>

    <footer class="chat-main__input">
      <form [formGroup]="chatForm" (ngSubmit)="onSubmit()">
        <input formControlName="message" type="text" placeholder="Escreva uma mensagem" />
        <button type="submit" [disabled]="chatForm.invalid">Enviar</button>
      </form>
    </footer>
  </main>

  <div class="chat-search" *ngIf="showSearchDialog">
    <div class="chat-search__content">
      <header>
        <h3>Encontrar usuários</h3>
        <button type="button" (click)="closeNewConversationDialog()">Fechar</button>
      </header>

      <div class="chat-search__form">
        <input
          type="text"
          placeholder="Digite um nome ou e-mail"
          [(ngModel)]="searchTerm"
          (keyup.enter)="searchUsers()"
        />
        <button type="button" (click)="searchUsers()" [disabled]="searchLoading">Pesquisar</button>
      </div>

      <p class="chat-search__hint" *ngIf="searchLoading">Procurando...</p>
      <p class="chat-search__hint" *ngIf="searchExecuted && !searchLoading && !searchResults.length">
        Nenhum usuário encontrado com esse termo.
      </p>

      <ul *ngIf="searchResults.length">
        <li *ngFor="let user of searchResults" (click)="selectSearchResult(user)">
          <img
            [src]="avatarSrc(user.avatarUrl)"
            [alt]="user.fullname || user.username"
            (error)="onAvatarError($event)"
          />
          <span>{{ user.fullname || user.username }}</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<ng-template #noUser>
  <div class="chat-empty">
    <p>Faça login para acessar o chat.</p>
  </div>
</ng-template>

<ng-template #emptyConversation>
  <section class="chat-main chat-main--empty">
    <p>Selecione uma conversa na lista ao lado ou inicie um novo chat.</p>
  </section>
</ng-template>